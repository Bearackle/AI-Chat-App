<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLaMA Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        .chat-container {
            max-width: 700px;
            margin: 0 auto;
        }
        .chat-box {
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 8px;
            padding: 12px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        .message {
            margin: 6px 0;
            white-space: pre-wrap;
        }
        .user {
            color: #007bff;
            font-weight: bold;
        }
        .assistant {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }
        button {
            padding: 10px 16px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
        }
        button:disabled {
            background: #999;
            cursor: not-allowed;
        }
        .input-group button {
            flex-shrink: 0;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <h1>ü¶ô LLaMA Chat</h1>
    <div class="chat-box" id="chatBox"></div>
    <form id="chatForm" class="input-group">
        <input
                type="text"
                id="promptInput"
                placeholder="Nh·∫≠p c√¢u h·ªèi..."
                required
        />
        <button type="submit" id="sendBtn">G·ª≠i</button>
        <button type="button" id="stopBtn" style="display: none;" disabled>D·ª´ng</button>
    </form>
</div>

<script>
    const chatBox = document.getElementById("chatBox");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("promptInput");
    const sendBtn = document.getElementById("sendBtn");
    let source = null;
    let retryCount = 0;
    const maxRetries = 3;
    var stopBtn = document.getElementById("stopBtn");
    stopBtn.addEventListener("click", function () {
        appendMessage("H·ªá th·ªëng", "‚õî ƒê√£ d·ª´ng ph·∫£n h·ªìi.", "error");
        closeConnection();
    });
    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const prompt = input.value.trim();
        if (!prompt) return;

        appendMessage("B·∫°n", prompt, "user");
        input.value = "";
        input.disabled = true;
        sendBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
        stopBtn.disabled = false;
        if (source) {
            console.log("ƒê√≥ng k·∫øt n·ªëi c≈©:", source.url);
            source.close();
            source = null;
        }

        const url = `/chat?prompt=${encodeURIComponent(prompt)}`;
        console.log("Ki·ªÉm tra k·∫øt n·ªëi t·ªõi:", url);
        try {
            const testResponse = await fetch(url, {
                method: "GET",
                headers: { Accept: "text/event-stream" },
            });
            console.log("Ki·ªÉm tra server:", {
                status: testResponse.status,
                ok: testResponse.ok,
                headers: Object.fromEntries(testResponse.headers.entries()),
            });
            if (!testResponse.ok) {
                throw new Error(`Server tr·∫£ v·ªÅ status: ${testResponse.status}`);
            }
            if (testResponse.headers.get("content-type") !== "text/event-stream") {
                throw new Error("Response kh√¥ng ph·∫£i text/event-stream");
            }
        } catch (err) {
            console.error("L·ªói khi ki·ªÉm tra server:", err.message);
            appendMessage("L·ªói", `Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server: ${err.message}`, "error");
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
            return;
        }

        source = new EventSource(url);
        console.log("Kh·ªüi t·∫°o EventSource:", url);

        let assistantMsg = "";
        let assistantDiv = appendMessage("LLaMA", "", "assistant", true);

        source.onopen = function () {
            console.log("K·∫øt n·ªëi SSE m·ªü:", source.url);
            retryCount = 0;
        };

        source.onmessage = function (event) {
            console.log("Nh·∫≠n d·ªØ li·ªáu SSE:", { data: event.data, length: event.data.length });
            if (event.data === "[DONE]") {
                console.log("Lu·ªìng ho√†n t·∫•t");
                closeConnection();
                return;
            }
            if (event.data.startsWith(":")) {
                console.log("B·ªè qua heartbeat message:", event.data);
                return;
            }
            if (event.data && event.data.trim() !== "" && event.data !== "[DONE]") {
                try {
                    // Lo·∫°i b·ªè "data: " v√† "\n\n", thay th·∫ø c√°c k√Ω t·ª± tho√°t
                    let content = event.data
                        .replace(/^data: /, '') // Lo·∫°i b·ªè "data: "
                        .replace(/\n\n$/, '')   // Lo·∫°i b·ªè "\n\n" ·ªü cu·ªëi
                        .replace(/\\n/g, '\n')  // Chuy·ªÉn \n th√†nh xu·ªëng d√≤ng th·ª±c
                        .replace(/\\r/g, '\r'); // Chuy·ªÉn \r th√†nh k√Ω t·ª± th·ª±c

                    assistantMsg += content;
                    assistantDiv.querySelector(".content").textContent = assistantMsg;
                    chatBox.scrollTop = chatBox.scrollHeight;
                } catch (err) {
                    console.warn("L·ªói x·ª≠ l√Ω d·ªØ li·ªáu SSE:", { error: err.message, data: event.data });
                }
            } else {
                console.warn("D·ªØ li·ªáu SSE r·ªóng:", event.data);
            }
        };

        source.onerror = function () {
            const errorDetails = {
                readyState: source ? source.readyState : "N/A",
                url: source ? source.url : url,
                retryCount: retryCount,
            };
            console.error("L·ªói k·∫øt n·ªëi SSE:", errorDetails);
            appendMessage("L·ªói", "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. ƒêang th·ª≠ l·∫°i...", "error");
            closeConnection();

            if (retryCount < maxRetries) {
                retryCount++;
                console.log(`Th·ª≠ k·∫øt n·ªëi l·∫°i (${retryCount}/${maxRetries}) sau 3 gi√¢y...`);
                setTimeout(() => {
                    form.dispatchEvent(new Event("submit"));
                }, 3000);
            } else {
                console.log("ƒê√£ ƒë·∫°t s·ªë l·∫ßn th·ª≠ t·ªëi ƒëa.");
                appendMessage(
                    "L·ªói",
                    "Kh√¥ng th·ªÉ k·∫øt n·ªëi sau nhi·ªÅu l·∫ßn th·ª≠. Vui l√≤ng ki·ªÉm tra server ho·∫∑c th·ª≠ l·∫°i sau.",
                    "error"
                );
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        };
    });

    function closeConnection() {
        if (source) {
            console.log("ƒê√≥ng k·∫øt n·ªëi SSE:", source.url);
            source.close();
            source = null;
        }
        input.disabled = false;
        sendBtn.style.display = "inline-block";
        stopBtn.style.display = "none";
        sendBtn.disabled = false;
        stopBtn.disabled = true;
        input.focus();
        // if (source) {
        //     console.log("ƒê√≥ng k·∫øt n·ªëi SSE:", source.url);
        //     source.close();
        //     source = null;
        // }
        // input.disabled = false;
        // sendBtn.disabled = false;
        // input.focus();
    }

    function appendMessage(name, text, role, returnDiv = false) {
        const msg = document.createElement("div");
        msg.classList.add("message");
        msg.innerHTML = `<span class="${role}">${name}:</span> <span class="content">${text}</span>`;
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
        return returnDiv ? msg : undefined;
    }

    window.addEventListener("beforeunload", () => {
        closeConnection();
    });
</script>
</body>
</html>